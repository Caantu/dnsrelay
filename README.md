# DNS Relay Server

一个轻量级的DNS中继服务器，支持本地域名解析、缓存管理和外部DNS转发功能。

## 功能特性

- **本地域名解析**: 从配置文件读取域名-IP映射，提供快速本地解析
- **智能缓存**: 自动缓存外部DNS查询结果，提高响应速度
- **外部DNS转发**: 本地未找到的域名自动转发到外部DNS服务器
- **多级调试输出**: 支持不同详细程度的日志输出
- **超时处理**: 自动处理外部DNS服务器无响应的情况

## 编译与运行

### 环境要求
- Windows 系统
- 支持C语言的编译器（如 Visual Studio、MinGW 等）
- Winsock2 库支持

### 编译
```bash
gcc -o dnsrelay dnsrelay.c -lws2_32
```

### 运行
```bash
# 基本运行（使用默认配置）
./dnsrelay

# 指定DNS服务器
./dnsrelay 8.8.8.8

# 指定配置文件
./dnsrelay hosts.txt

# 启用调试模式
./dnsrelay -d                    # 基本调试信息
./dnsrelay -dd                   # 详细调试信息

# 完整参数
./dnsrelay -dd 8.8.8.8 hosts.txt
```

## 参数说明

| 参数 | 说明 | 默认值 |
|------|------|--------|
| DNS服务器 | 外部DNS服务器IP地址 | 10.3.9.6 |
| 配置文件 | 本地域名解析配置文件 | dnsrelay.txt |
| `-d` | 启用基本调试输出 | 关闭 |
| `-dd` | 启用详细调试输出 | 关闭 |

## 配置文件格式

创建 `dnsrelay.txt` 文件，每行格式为：
```
IP地址 域名
```

示例：
```
192.168.1.100 local.example.com
10.0.0.50 internal.company.com
0.0.0.0 blocked.site.com
```

> 注意：IP地址为 `0.0.0.0` 表示屏蔽该域名

## 工作原理

1. **接收DNS查询**: 监听53端口，接收客户端DNS查询请求
2. **本地查找**: 首先在配置文件中查找域名对应的IP地址
3. **缓存查找**: 如果本地未找到，检查缓存中是否有该域名的记录
4. **外部转发**: 如果缓存也未命中，转发请求到外部DNS服务器
5. **结果缓存**: 将外部DNS服务器的响应结果缓存，并返回给客户端

## 缓存机制

- 缓存有效期：30秒（可在代码中修改 `CACHE_TTL` 常量）
- 自动过期清理：定期清理过期的缓存记录
- 动态更新：外部DNS查询结果自动添加到本地资源列表

## 调试输出

### `-d` 模式
显示基本信息：
- 查询序号、时间戳
- 客户端IP地址
- 查询的域名

### `-dd` 模式  
显示详细信息：
- DNS报文头部详细信息
- 查询和响应的原始数据
- 缓存命中/未命中状态
- IP地址解析结果
- 发送/接收状态

## 技术实现

- **协议支持**: DNS over UDP (RFC 1035)
- **并发处理**: 单线程事件循环处理多个客户端请求
- **ID映射**: 智能管理DNS查询ID，避免冲突
- **超时控制**: 20秒外部DNS查询超时机制

## 注意事项

- 需要管理员权限运行（绑定53端口）
- 确保防火墙允许UDP 53端口通信
- 配置文件路径相对于程序执行目录
- 支持IPv4 A记录查询，其他类型查询会被忽略

## 作者

Designer: 李可欣
